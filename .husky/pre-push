#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-push validation..."
echo ""

# TypeScript/JavaScript checks
echo "üì¶ JavaScript/TypeScript validation..."
echo "  ‚Üí Running Biome lint and format check..."
pnpm lint || exit 1

echo "  ‚Üí Running TypeScript type check..."
pnpm typecheck || exit 1

echo "  ‚Üí Running tests..."
pnpm test || exit 1

echo ""

# Protocol validation
echo "üìã Protocol validation..."
echo "  ‚Üí Running buf lint..."
pnpm --filter @gouide/protocol codegen:lint || exit 1

# Check if protocol files changed (against origin/main)
# Only enforce breaking changes for v1.0.0+
CHANGED_PROTOS=$(git diff origin/main...HEAD --name-only | grep "^protocol/.*\.proto$" || true)
PROTOCOL_VERSION=$(grep -o '"version": "[^"]*"' packages/protocol/package.json | head -1 | cut -d'"' -f4)
if [ -n "$CHANGED_PROTOS" ]; then
  echo "  ‚Üí Protocol files changed (version $PROTOCOL_VERSION)"
  if [[ "$PROTOCOL_VERSION" =~ ^0\. ]]; then
    echo "  ‚Ñπ  Skipping buf breaking check (pre-1.0 allows breaking changes)"
  else
    echo "  ‚Üí Running buf breaking check..."
    pnpm --filter @gouide/protocol codegen:breaking || exit 1
  fi
fi

echo ""

# Rust checks
echo "ü¶Ä Rust validation..."
echo "  ‚Üí Running cargo fmt check..."
cd core && cargo fmt --all -- --check || exit 1

echo "  ‚Üí Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings || exit 1

echo "  ‚Üí Running cargo test..."
cargo test --all-features || exit 1

echo "  ‚Üí Running cargo build..."
cargo build --release || exit 1

cd ..

echo ""

# Desktop app checks
echo "üñ•Ô∏è  Desktop app validation..."
echo "  ‚Üí Running cargo fmt check..."
cd apps/desktop/src-tauri && cargo fmt --all -- --check || exit 1

echo "  ‚Üí Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings || exit 1

echo "  ‚Üí Running cargo build..."
cargo build --release || exit 1

cd ../../..

echo ""
echo "‚úÖ All pre-push checks passed! Pushing to remote..."
