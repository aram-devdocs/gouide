#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-push validation..."
echo ""

# TypeScript/JavaScript checks
echo "ğŸ“¦ JavaScript/TypeScript validation..."
echo "  â†’ Running Biome lint and format check..."
pnpm lint || exit 1

echo "  â†’ Running TypeScript type check..."
pnpm typecheck || exit 1

echo "  â†’ Running tests..."
pnpm test || exit 1

echo ""

# Protocol validation
echo "ğŸ“‹ Protocol validation..."
echo "  â†’ Running buf lint..."
pnpm --filter @gouide/protocol codegen:lint || exit 1

# Check if protocol files changed (against origin/main)
# Only enforce breaking changes for v1.0.0+
CHANGED_PROTOS=$(git diff origin/main...HEAD --name-only | grep "^protocol/.*\.proto$" || true)
PROTOCOL_VERSION=$(grep -o '"version": "[^"]*"' packages/protocol/package.json | head -1 | cut -d'"' -f4)
if [ -n "$CHANGED_PROTOS" ]; then
  echo "  â†’ Protocol files changed (version $PROTOCOL_VERSION)"
  if [[ "$PROTOCOL_VERSION" =~ ^0\. ]]; then
    echo "  â„¹  Skipping buf breaking check (pre-1.0 allows breaking changes)"
  else
    echo "  â†’ Running buf breaking check..."
    pnpm --filter @gouide/protocol codegen:breaking || exit 1
  fi
fi

echo ""

# Rust checks
echo "ğŸ¦€ Rust validation..."
echo "  â†’ Running cargo fmt check..."
cd core && cargo fmt --all -- --check || exit 1

echo "  â†’ Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings || exit 1

echo "  â†’ Running cargo test..."
cargo test --all-features || exit 1

echo "  â†’ Running cargo build..."
cargo build --release || exit 1

cd ..

echo ""

# Desktop app checks
echo "ğŸ–¥ï¸  Desktop app validation..."
echo "  â†’ Running cargo fmt check..."
cd apps/desktop/src-tauri && cargo fmt --all -- --check || exit 1

echo "  â†’ Running cargo clippy..."
cargo clippy --all-targets --all-features -- -D warnings || exit 1

echo "  â†’ Running cargo build..."
cargo build --release || exit 1

cd ../../..

echo ""

echo "ğŸ—ï¸  UI Architecture validation..."
./scripts/validate-ui-architecture.sh || exit 1

echo ""
echo "âœ… All pre-push checks passed! Pushing to remote..."
